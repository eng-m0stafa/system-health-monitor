name: 🏥 Health Monitor CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: 🧪 Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3
    
    - name: 🔧 Make scripts executable
      run: chmod +x scripts/*.sh
    
    - name: 🧪 Run test suite
      run: ./scripts/test.sh
    
    - name: ✅ Test health check execution
      run: |
        echo "Testing health check script..."
        ./scripts/health-check.sh
        echo "Health check completed successfully!"

  build:
    name: 🐳 Build Docker Image
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3
    
    - name: 🐳 Build Docker image
      run: docker build -t health-monitor:latest .
    
    - name: 🧪 Test Docker container
      run: |
        echo "Testing Docker container..."
        docker run --rm health-monitor:latest > docker-output.txt
        
        # Check if output was generated
        if [ -s docker-output.txt ]; then
          echo "✅ Container test passed!"
          echo "Container output preview:"
          head -5 docker-output.txt
        else
          echo "❌ Container test failed - no output"
          exit 1
        fi
    
    - name: 📊 Show build summary
      run: |
        echo "🎉 Build completed successfully!"
        docker images health-monitor:latest